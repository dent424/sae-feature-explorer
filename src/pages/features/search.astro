---
import BaseLayout from '../../components/layout/BaseLayout.astro';
import FeatureCard from '../../components/features/FeatureCard.astro';
import { loadFeaturesIndex, type FeatureIndexEntry } from '../../lib/data';

// Load all features for search
const allFeatures = loadFeaturesIndex();

// Create a lightweight search index (just what we need for searching and display)
const searchIndex = allFeatures.map(f => ({
  id: f.feature_index,
  interp: f.interpretation,
  rc: f.rank_control,
  rnc: f.rank_nocontrol,
  vs: f.verify_status || '',
  pl: f.paralinguistic || '',
  hd: f.hasData
}));
---

<BaseLayout title="Search Features - SAE Feature Explorer">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="mb-8">
      <div class="flex flex-col gap-4">
        <div>
          <h1 class="text-3xl font-bold text-gray-900">Search Features</h1>
          <p class="text-gray-600 mt-2">
            Search {allFeatures.length.toLocaleString()} features by interpretation.
          </p>
        </div>

        <!-- Search Input -->
        <div class="flex gap-2">
          <input
            type="text"
            id="search-input"
            placeholder="Search interpretations..."
            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          />
          <button
            id="clear-btn"
            class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 hidden"
          >
            Clear
          </button>
        </div>

        <p id="result-count" class="text-sm text-gray-500"></p>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loading" class="hidden text-center py-8">
      <div class="inline-flex items-center gap-2 text-gray-500">
        <svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Searching...
      </div>
    </div>

    <!-- Results Container -->
    <div id="results" class="grid gap-4">
      <p class="text-gray-500">Enter a search term to find features.</p>
    </div>

    <!-- Load More Button -->
    <div id="load-more-container" class="mt-8 flex justify-center hidden">
      <button
        id="load-more-btn"
        class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
      >
        Load More
      </button>
    </div>
  </div>

  <!-- Embed search data -->
  <script define:vars={{ searchIndex }}>
    window.searchIndex = searchIndex;
  </script>

  <script>
    // Type declaration for search index on window
    interface SearchFeature {
      id: number;
      interp: string;
      rc: number;
      rnc: number;
      vs: string;
      pl: string;
      hd: boolean;
    }
    declare global {
      interface Window {
        searchIndex: SearchFeature[];
      }
    }

    const searchInput = document.getElementById('search-input') as HTMLInputElement;
    const clearBtn = document.getElementById('clear-btn') as HTMLButtonElement;
    const resultsContainer = document.getElementById('results') as HTMLDivElement;
    const resultCount = document.getElementById('result-count') as HTMLParagraphElement;
    const loadMoreContainer = document.getElementById('load-more-container') as HTMLDivElement;
    const loadMoreBtn = document.getElementById('load-more-btn') as HTMLButtonElement;
    const loadingEl = document.getElementById('loading') as HTMLDivElement;

    let currentResults: SearchFeature[] = [];
    let displayedCount = 0;
    const RESULTS_PER_PAGE = 50;

    function escapeHtml(text: string): string {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function highlightMatch(text: string, query: string): string {
      if (!query) return escapeHtml(text);
      const escaped = escapeHtml(text);
      const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
      return escaped.replace(regex, '<mark class="bg-yellow-200">$1</mark>');
    }

    function renderFeature(feature: SearchFeature, query: string): string {
      const statusBadge = feature.vs ? `
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
          feature.vs === 'PASS' ? 'bg-green-100 text-green-800' :
          feature.vs === 'FAIL' ? 'bg-red-100 text-red-800' :
          'bg-yellow-100 text-yellow-800'
        }">${escapeHtml(feature.vs)}</span>
      ` : '';

      const hasDataBadge = feature.hd ? `
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">Has Data</span>
      ` : '';

      const paralinguisticBadge = feature.pl === 'TRUE' ? `
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">Paralinguistic</span>
      ` : '';

      const interpretation = feature.interp || 'No interpretation available';
      const truncated = interpretation.length > 200 ? interpretation.slice(0, 200) + '...' : interpretation;

      return `
        <a href="/features/${feature.id}" class="block bg-white border border-gray-200 rounded-lg p-4 hover:border-blue-300 hover:shadow-sm transition-all">
          <div class="flex items-start justify-between gap-4">
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-2">
                <h3 class="text-lg font-semibold text-gray-900">Feature ${feature.id}</h3>
                ${hasDataBadge}
                ${paralinguisticBadge}
              </div>
              <p class="text-gray-600 text-sm">${highlightMatch(truncated, query)}</p>
              <p class="text-xs text-gray-400 mt-2">Rank (ctrl): ${feature.rc.toFixed(0)} | Rank (no-ctrl): ${feature.rnc.toFixed(0)}</p>
            </div>
            ${statusBadge}
          </div>
        </a>
      `;
    }

    function displayResults(query: string) {
      const trimmedQuery = query.trim().toLowerCase();

      if (!trimmedQuery) {
        resultsContainer.innerHTML = '<p class="text-gray-500">Enter a search term to find features.</p>';
        resultsContainer.classList.remove('hidden');
        loadingEl.classList.add('hidden');
        resultCount.textContent = '';
        loadMoreContainer.classList.add('hidden');
        clearBtn.classList.add('hidden');
        return;
      }

      clearBtn.classList.remove('hidden');
      loadingEl.classList.add('hidden');
      resultsContainer.classList.remove('hidden');

      // Filter features
      currentResults = window.searchIndex.filter((f: SearchFeature) =>
        f.interp.toLowerCase().includes(trimmedQuery)
      );

      // Sort by rank_control
      currentResults.sort((a: SearchFeature, b: SearchFeature) => a.rc - b.rc);

      displayedCount = 0;
      resultsContainer.innerHTML = '';

      if (currentResults.length === 0) {
        resultsContainer.innerHTML = '<p class="text-gray-500">No features found matching your search.</p>';
        resultCount.textContent = '0 results';
        loadMoreContainer.classList.add('hidden');
        return;
      }

      resultCount.textContent = `${currentResults.length.toLocaleString()} result${currentResults.length === 1 ? '' : 's'}`;
      loadMore(query);
    }

    function loadMore(query: string) {
      const trimmedQuery = query.trim();
      const nextBatch = currentResults.slice(displayedCount, displayedCount + RESULTS_PER_PAGE);

      nextBatch.forEach((feature: SearchFeature) => {
        const div = document.createElement('div');
        div.innerHTML = renderFeature(feature, trimmedQuery);
        resultsContainer.appendChild(div.firstElementChild!);
      });

      displayedCount += nextBatch.length;

      if (displayedCount < currentResults.length) {
        loadMoreContainer.classList.remove('hidden');
        loadMoreBtn.textContent = `Load More (${currentResults.length - displayedCount} remaining)`;
      } else {
        loadMoreContainer.classList.add('hidden');
      }
    }

    // Debounce search
    let debounceTimer: ReturnType<typeof setTimeout>;
    searchInput.addEventListener('input', () => {
      clearTimeout(debounceTimer);

      // Show loading state if there's input
      const query = searchInput.value.trim();
      if (query) {
        resultsContainer.classList.add('hidden');
        loadingEl.classList.remove('hidden');
      }

      debounceTimer = setTimeout(() => {
        displayResults(searchInput.value);
      }, 300);
    });

    clearBtn.addEventListener('click', () => {
      searchInput.value = '';
      displayResults('');
      searchInput.focus();
    });

    loadMoreBtn.addEventListener('click', () => {
      loadMore(searchInput.value);
    });

    // Focus search input on load
    searchInput.focus();
  </script>
</BaseLayout>
