---
import BaseLayout from '../../components/layout/BaseLayout.astro';
import StatsBar from '../../components/features/StatsBar.astro';
import TopTokensTable from '../../components/features/TopTokensTable.astro';
import ActivationsDisplay from '../../components/features/ActivationsDisplay.astro';
import NgramTabs from '../../components/features/NgramTabs.astro';
import CoactivationList from '../../components/features/CoactivationList.astro';
import PositionChart from '../../components/features/PositionChart.astro';
import { loadFeaturesWithData, loadFeatureData, getFeatureFromIndex, loadFeaturesIndex } from '../../lib/data';

export function getStaticPaths() {
  const featureIds = loadFeaturesWithData();
  return featureIds.map(id => ({
    params: { id: String(id) }
  }));
}

const { id } = Astro.params;
const featureId = parseInt(id as string, 10);

// Load feature data
const featureData = loadFeatureData(featureId);
const indexEntry = getFeatureFromIndex(featureId);

if (!featureData) {
  return Astro.redirect('/features');
}

// Get prev/next feature IDs (from features that have data)
const featureIds = loadFeaturesWithData().sort((a, b) => a - b);
const currentIndex = featureIds.indexOf(featureId);
const prevFeatureId = currentIndex > 0 ? featureIds[currentIndex - 1] : null;
const nextFeatureId = currentIndex < featureIds.length - 1 ? featureIds[currentIndex + 1] : null;

// Build interpretations lookup for coactivated features
const allFeatures = loadFeaturesIndex();
const coactivatedIds = new Set((featureData.coactivation?.coactivated_features || []).map(c => c.feature_idx));
const interpretations: Record<number, string> = {};
for (const feature of allFeatures) {
  if (coactivatedIds.has(feature.feature_index) && feature.interpretation) {
    interpretations[feature.feature_index] = feature.interpretation;
  }
}

// Badge colors
const verifyStatusColors: Record<string, string> = {
  'PASS': 'bg-green-100 text-green-800',
  'FAIL': 'bg-red-100 text-red-800',
  'PARTIAL': 'bg-yellow-100 text-yellow-800',
  'WARN': 'bg-yellow-100 text-yellow-800',
};

const verifyStatusColor = indexEntry?.verify_status
  ? verifyStatusColors[indexEntry.verify_status] || 'bg-gray-100 text-gray-800'
  : null;
---

<BaseLayout title={`Feature ${featureId} - SAE Feature Explorer`}>
  <!-- Sticky Header (appears on scroll) -->
  <div id="sticky-header" class="fixed top-0 left-0 right-0 bg-white border-b border-gray-200 shadow-sm z-50 transform -translate-y-full transition-transform duration-200">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex items-center justify-between">
      <div class="flex items-center space-x-4">
        <a href="/features" class="text-blue-600 hover:text-blue-800 text-sm">
          &larr; Back
        </a>
        <h2 class="text-lg font-bold text-gray-900">Feature {featureId}</h2>
      </div>
      <div class="flex items-center space-x-2">
        {indexEntry?.verify_status && verifyStatusColor && (
          <span class={`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${verifyStatusColor}`}>
            {indexEntry.verify_status}
          </span>
        )}
        {indexEntry?.paralinguistic === 'TRUE' && (
          <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
            Paralinguistic
          </span>
        )}
      </div>
    </div>
  </div>

  <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Breadcrumb -->
    <nav class="mb-4 text-sm" aria-label="Breadcrumb">
      <ol class="flex items-center space-x-2">
        <li>
          <a href="/" class="text-gray-500 hover:text-gray-700">Home</a>
        </li>
        <li class="text-gray-400">/</li>
        <li>
          <a href="/features" class="text-gray-500 hover:text-gray-700" id="back-link">Features</a>
        </li>
        <li class="text-gray-400">/</li>
        <li class="text-gray-900 font-medium">Feature {featureId}</li>
      </ol>
    </nav>

    <!-- Header -->
    <div class="mb-6" id="main-header">
      <div class="flex items-center justify-between mb-2">
        <span></span> <!-- Spacer for flex justify-between -->
        <!-- Prev/Next Navigation -->
        <div class="flex items-center space-x-2">
          {prevFeatureId !== null ? (
            <a
              href={`/features/${prevFeatureId}`}
              class="inline-flex items-center px-3 py-1 text-sm font-medium text-gray-700 bg-gray-100 rounded hover:bg-gray-200"
              title={`Previous: Feature ${prevFeatureId}`}
            >
              <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
              </svg>
              Prev
            </a>
          ) : (
            <span class="inline-flex items-center px-3 py-1 text-sm font-medium text-gray-400 bg-gray-50 rounded cursor-not-allowed">
              <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
              </svg>
              Prev
            </span>
          )}
          <span class="text-xs text-gray-400">{currentIndex + 1} of {featureIds.length}</span>
          {nextFeatureId !== null ? (
            <a
              href={`/features/${nextFeatureId}`}
              class="inline-flex items-center px-3 py-1 text-sm font-medium text-gray-700 bg-gray-100 rounded hover:bg-gray-200"
              title={`Next: Feature ${nextFeatureId}`}
            >
              Next
              <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </a>
          ) : (
            <span class="inline-flex items-center px-3 py-1 text-sm font-medium text-gray-400 bg-gray-50 rounded cursor-not-allowed">
              Next
              <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </span>
          )}
        </div>
      </div>
      <div class="flex items-center justify-between">
        <h1 class="text-3xl font-bold text-gray-900">
          Feature {featureId}
        </h1>
        <div class="flex items-center space-x-2">
          {indexEntry?.verify_status && verifyStatusColor && (
            <span class={`inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${verifyStatusColor}`}>
              {indexEntry.verify_status}
            </span>
          )}
          {indexEntry?.paralinguistic === 'TRUE' && (
            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-purple-100 text-purple-800">
              Paralinguistic
            </span>
          )}
        </div>
      </div>
    </div>

    <!-- Interpretation (Hero) -->
    {indexEntry?.interpretation && (
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-8">
        <h2 class="text-lg font-semibold text-blue-900 mb-2">Interpretation</h2>
        <p class="text-blue-800 text-lg leading-relaxed">
          {indexEntry.interpretation}
        </p>
      </div>
    )}

    <!-- Stats Bar -->
    <div class="mb-8">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Statistics</h2>
      <StatsBar
        activationRate={featureData.stats.activation_rate}
        meanWhenActive={featureData.stats.mean_when_active}
        maxActivation={featureData.stats.max_activation}
        stdWhenActive={featureData.stats.std_when_active}
      />
    </div>

    <!-- Tabs Section -->
    <div class="space-y-8">
      <!-- Top Activations -->
      <section>
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Top Activations</h2>
        <ActivationsDisplay activations={featureData.top_activations?.activations || []} />
      </section>

      <!-- Top Tokens -->
      <section>
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Top Tokens</h2>
        <TopTokensTable tokens={featureData.top_tokens?.top_tokens || []} />
      </section>

      <!-- N-gram Analysis -->
      <section>
        <h2 class="text-lg font-semibold text-gray-900 mb-4">N-gram Analysis</h2>
        <NgramTabs ngrams={featureData.ngram_analysis?.ngrams || { '2grams': [], '3grams': [], '4grams': [] }} />
      </section>

      <!-- Position Distribution -->
      <section>
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Position Distribution</h2>
        <div class="bg-gray-50 rounded-lg p-6">
          <PositionChart bins={featureData.position_distribution?.bins || []} />
        </div>
      </section>

      <!-- Coactivation -->
      <section>
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Frequently Coactivated Features</h2>
        <div class="bg-white border border-gray-200 rounded-lg p-4">
          <CoactivationList coactivations={featureData.coactivation?.coactivated_features || []} interpretations={interpretations} />
        </div>
      </section>
    </div>

    <!-- Rank Info -->
    {indexEntry && (
      <div class="mt-8 pt-6 border-t border-gray-200 text-sm text-gray-500">
        <div class="flex space-x-6">
          <span>Rank (control): {indexEntry.rank_control.toFixed(0)}</span>
          <span>Rank (no control): {indexEntry.rank_nocontrol.toFixed(0)}</span>
        </div>
      </div>
    )}

    <!-- Keyboard Shortcuts Hint -->
    <div class="mt-6 text-center text-xs text-gray-400 space-x-4">
      <span><kbd class="px-1.5 py-0.5 bg-gray-100 border border-gray-300 rounded text-gray-600">←</kbd> / <kbd class="px-1.5 py-0.5 bg-gray-100 border border-gray-300 rounded text-gray-600">K</kbd> Previous</span>
      <span><kbd class="px-1.5 py-0.5 bg-gray-100 border border-gray-300 rounded text-gray-600">→</kbd> / <kbd class="px-1.5 py-0.5 bg-gray-100 border border-gray-300 rounded text-gray-600">J</kbd> Next</span>
      <span><kbd class="px-1.5 py-0.5 bg-gray-100 border border-gray-300 rounded text-gray-600">/</kbd> Search</span>
      <span><kbd class="px-1.5 py-0.5 bg-gray-100 border border-gray-300 rounded text-gray-600">Esc</kbd> Back to list</span>
    </div>
  </div>

  <script define:vars={{ featureId, prevFeatureId, nextFeatureId }}>
    // Show sticky header when scrolled past the main header
    const stickyHeader = document.getElementById('sticky-header');
    const mainHeader = document.getElementById('main-header');

    if (stickyHeader && mainHeader) {
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              // Main header is visible, hide sticky header
              stickyHeader.classList.add('-translate-y-full');
            } else {
              // Main header is not visible, show sticky header
              stickyHeader.classList.remove('-translate-y-full');
            }
          });
        },
        { threshold: 0, rootMargin: '-80px 0px 0px 0px' }
      );
      observer.observe(mainHeader);
    }

    // Keyboard shortcuts: j/k/arrows for previous/next feature, / for search
    document.addEventListener('keydown', (e) => {
      // Ignore if typing in an input
      if (e.target instanceof HTMLInputElement || e.target instanceof HTMLTextAreaElement) return;

      if ((e.key === 'j' || e.key === 'J' || e.key === 'ArrowRight') && nextFeatureId !== null) {
        // Next feature
        window.location.href = `/features/${nextFeatureId}`;
      } else if ((e.key === 'k' || e.key === 'K' || e.key === 'ArrowLeft') && prevFeatureId !== null) {
        // Previous feature
        window.location.href = `/features/${prevFeatureId}`;
      } else if (e.key === '/') {
        e.preventDefault();
        window.location.href = '/features/search';
      } else if (e.key === 'Escape') {
        // Go back to features list (restore scroll position)
        const backLink = document.getElementById('back-link');
        if (backLink) {
          window.location.href = backLink.getAttribute('href') || '/features';
        } else {
          window.location.href = '/features';
        }
      }
    });
  </script>
</BaseLayout>
